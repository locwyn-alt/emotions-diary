<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåø –î–Ω–µ–≤–Ω–∏–∫ —ç–º–æ—Ü–∏–π</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background-color: #f9f7f6;
    color: #333;
    padding: 20px;
    max-width: 800px;
    margin: auto;
  }
  h2 {
    text-align: center;
    margin-bottom: 16px;
    color: #5a5a5a;
  }

  /* üîß –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ */
  #emotion-filters {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    justify-content: center;
    margin-bottom: 20px;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  #emotion-filters button {
    padding: 10px 12px;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    white-space: nowrap;
    transition: all 0.2s ease;
  }

  #emotion-filters button.active {
    background-color: #6a1b9a;
    color: white;
  }

  #emotion-filters button.inactive {
    background-color: #ccc;
    color: #888;
    cursor: default;
  }

  /* üß© –®–∏—Ä–æ–∫–∞—è –∫–Ω–æ–ø–∫–∞ "–í—Å–µ —ç–º–æ—Ü–∏–∏" */
  #emotion-filters button.all-emotions {
    grid-column: span 4;
  }

  #emotion-list .entry {
    background-color: #fff;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  #emotion-list .entry h4 {
    margin: 0 0 6px 0;
    color: #6a1b9a;
  }
  #emotion-list .entry p {
    margin: 2px 0;
    color: #555;
  }
</style>
</head>
<body>

<h2>üåø –í–∞—à–∏ —ç–º–æ—Ü–∏–∏</h2>

<div id="emotion-filters">
  <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è -->
</div>

<div id="emotion-list"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxID_jyzS4sGpjnLUZycfsbGoCuoqKQCzRjv_AoqnjeqWEV57ZL7qDgn5KIpWdpO-73/exec";
const clientId = new URLSearchParams(window.location.search).get('client_id') || 'defaultClient';

const EMOTIONS = [
  { id: "joy", text: "üòä –†–∞–¥–æ—Å—Ç—å / –≤–æ—Å—Ç–æ—Ä–≥" },
  { id: "sadness", text: "üò¢ –ì—Ä—É—Å—Ç—å / –ø–µ—á–∞–ª—å" },
  { id: "anger", text: "üò† –ó–ª–æ—Å—Ç—å / –¥–æ—Å–∞–¥–∞" },
  { id: "fear", text: "üò® –°—Ç—Ä–∞—Ö / —Ç—Ä–µ–≤–æ–≥–∞" },
  { id: "surprise", text: "üòÆ –£–¥–∏–≤–ª–µ–Ω–∏–µ / –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–µ" },
  { id: "disgust", text: "ü§¢ –ë—Ä–µ–∑–≥–ª–∏–≤–æ—Å—Ç—å / —Å–∫—É–∫–∞" },
  { id: "interest", text: "üßê –û–∂–∏–¥–∞–Ω–∏–µ / –∏–Ω—Ç–µ—Ä–µ—Å" },
  { id: "trust", text: "ü§ó –î–æ–≤–µ—Ä–∏–µ / –ø—Ä–∏–Ω—è—Ç–∏–µ" }
];

const emotionMap = {
  "üò¢ –ì—Ä—É—Å—Ç—å / –ø–µ—á–∞–ª—å": "sadness",
  "üò† –ó–ª–æ—Å—Ç—å / —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ": "anger",
  "üòÆ –£–¥–∏–≤–ª–µ–Ω–∏–µ / –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–µ": "surprise",
  "ü§ó –î–æ–≤–µ—Ä–∏–µ / –ø—Ä–∏–Ω—è—Ç–∏–µ": "trust",
  "üòä –†–∞–¥–æ—Å—Ç—å / —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ": "joy",
  "üò® –°—Ç—Ä–∞—Ö / —Ç—Ä–µ–≤–æ–≥–∞": "fear",
  "ü§¢ –û—Ç–≤—Ä–∞—â–µ–Ω–∏–µ / –Ω–µ–ø—Ä–∏—è–∑–Ω—å": "disgust",
  "üßê –û–∂–∏–¥–∞–Ω–∏–µ / –∏–Ω—Ç–µ—Ä–µ—Å": "interest",
  "üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ": "neutral"
};

function normalizeEmotionId(emotion_type, emotion_id) {
  const validIds = EMOTIONS.map(e => e.id);
  const cleanedId = emotion_id?.trim()?.toLowerCase();
  if (validIds.includes(cleanedId)) return cleanedId;
  return emotionMap[emotion_type] || "unknown";
}

let allEntries = [];

async function fetchEmotions() {
  try {
    const response = await fetch(`${API_URL}?client_id=${encodeURIComponent(clientId)}`);
    const data = await response.json ? await response.json() : await response.text().then(JSON.parse);
    allEntries = data;
    renderFilters();
    renderEmotions(allEntries);
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:", err);
    document.getElementById('emotion-list').innerHTML = "<p style='text-align:center;'>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–ø–∏—Å–∏.</p>";
  }
}

function renderFilters() {
  const container = document.getElementById('emotion-filters');
  container.innerHTML = "";

  const counts = {};
  EMOTIONS.forEach(em => {
    counts[em.id] = allEntries.filter(e =>
      normalizeEmotionId(e.emotion_type, e.emotion_id) === em.id
    ).length;
  });

  const allActive = allEntries.length > 0;
  const btnAll = document.createElement('button');
  btnAll.textContent = "–í—Å–µ —ç–º–æ—Ü–∏–∏";
  btnAll.className = allActive ? "active all-emotions" : "inactive all-emotions";
  if (allActive) btnAll.onclick = () => renderEmotions(allEntries);
  container.appendChild(btnAll);

  EMOTIONS.forEach(em => {
    const btn = document.createElement('button');
    btn.textContent = em.text;

    if (counts[em.id] > 0) {
      btn.className = "active";
      btn.onclick = () => {
        const filtered = allEntries.filter(e =>
          normalizeEmotionId(e.emotion_type, e.emotion_id) === em.id
        );
        renderEmotions(filtered);
      };
    } else {
      btn.className = "inactive";
    }

    container.appendChild(btn);
  });
}

function renderEmotions(entries) {
  const container = document.getElementById('emotion-list');
  container.innerHTML = "";
  if (entries.length === 0) {
    container.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —ç–º–æ—Ü–∏–∏.</p>";
    return;
  }

  entries.forEach(e => {
    const div = document.createElement('div');
    div.className = "entry";
    div.innerHTML = `
      <h4>${e.emotion_type}</h4>
      <p><b>–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å:</b> ${e.emotion_intens}/10</p>
      <p><b>–°–∏—Ç—É–∞—Ü–∏—è:</b> ${e.emotion_context}</p>
      <p><b>–†–µ–∞–∫—Ü–∏—è:</b> ${e.emotion_reflex}</p>
      <p><b>–ú—ã—Å–ª–∏:</b> ${e.emotion_think}</p>
      <p style="font-size:12px; color:#999;">${new Date(e.date).toLocaleString()}</p>
    `;
    container.appendChild(div);
  });
}

fetchEmotions();
</script>

</body>
</html>
