<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üåø –î–Ω–µ–≤–Ω–∏–∫ —ç–º–æ—Ü–∏–π</title>
  <style>
    :root {
      --bg-color: #f9f7f6;
      --text-color: #333;
      --card-bg: #fff;
      --accent-color: #6a1b9a;
      --button-bg: #6a1b9a;
      --button-text: #fff;
    }

    body.dark {
      --bg-color: #1e1e1e;
      --text-color: #eee;
      --card-bg: #2c2c2c;
      --accent-color: #bb86fc;
      --button-bg: #bb86fc;
      --button-text: #000;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 20px;
      max-width: 800px;
      margin: auto;
      transition: background-color 0.4s ease, color 0.4s ease;
    }

    h2 {
      text-align: center;
      margin-bottom: 16px;
      color: var(--text-color);
    }

    #theme-toggle {
      display: block;
      margin: 0 auto 20px auto;
      padding: 8px 16px;
      border-radius: 20px;
      background-color: var(--button-bg);
      color: var(--button-text);
      border: none;
      cursor: pointer;
      font-size: 20px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    #theme-toggle.clicked {
      animation: pulse 0.4s ease;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    /* üíª –°–µ—Ç–∫–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
    #emotion-filters {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      justify-content: center;
      margin-bottom: 20px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    #emotion-filters button {
      padding: 10px 12px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      transition: all 0.2s ease;
    }

    #emotion-filters button.active {
      background-color: var(--button-bg);
      color: var(--button-text);
    }

    #emotion-filters button.inactive {
      background-color: #ccc;
      color: #888;
      cursor: default;
    }

    #emotion-filters button.all-emotions {
      grid-column: span 4;
    }

    
    /* üì± –û–±–ª–∞–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
   @media (max-width: 820px) {
     body {
  background-color: red;
}
     
  #emotion-filters {
    all: unset;
    display: flex !important;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    margin-bottom: 20px;
    max-width: 100%;
    margin-left: auto;
    margin-right: auto;
  }

  #emotion-filters button {
    flex: 0 0 auto;
    margin: 6px;
    padding: 10px 12px;
    font-size: 14px;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s ease;
  }

  #emotion-filters button.all-emotions {
    flex-basis: 100%;
    text-align: center;
  }
}

    #emotion-list .entry {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: background-color 0.4s ease;
    }

    #emotion-list .entry h4 {
      margin: 0 0 6px 0;
      color: var(--accent-color);
    }

    #emotion-list .entry p {
      margin: 2px 0;
      color: var(--text-color);
    }

    #loader {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      z-index: 9999;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--accent-color);
      border-top: 4px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loader">
    <div class="spinner"></div>
    <p>–ó–∞–≥—Ä—É–∂–∞–µ–º —ç–º–æ—Ü–∏–∏...</p>
  </div>

  <main style="display:none;">
    <h2>üåø –í–∞—à–∏ —ç–º–æ—Ü–∏–∏</h2>
    <button id="theme-toggle">üåô</button>
    <div id="emotion-filters"></div>
    <div id="emotion-list"></div>
  </main>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxID_jyzS4sGpjnLUZycfsbGoCuoqKQCzRjv_AoqnjeqWEV57ZL7qDgn5KIpWdpO-73/exec";
    const clientId = new URLSearchParams(window.location.search).get('client_id') || 'defaultClient';

    const EMOTIONS = [
      { id: "joy", text: "üòä –†–∞–¥–æ—Å—Ç—å / –≤–æ—Å—Ç–æ—Ä–≥" },
      { id: "sadness", text: "üò¢ –ì—Ä—É—Å—Ç—å / –ø–µ—á–∞–ª—å" },
      { id: "anger", text: "üò† –ó–ª–æ—Å—Ç—å / –¥–æ—Å–∞–¥–∞" },
      { id: "fear", text: "üò® –°—Ç—Ä–∞—Ö / —Ç—Ä–µ–≤–æ–≥–∞" },
      { id: "surprise", text: "üòÆ –£–¥–∏–≤–ª–µ–Ω–∏–µ / –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–µ" },
      { id: "disgust", text: "ü§¢ –ë—Ä–µ–∑–≥–ª–∏–≤–æ—Å—Ç—å / —Å–∫—É–∫–∞" },
      { id: "interest", text: "üßê –û–∂–∏–¥–∞–Ω–∏–µ / –∏–Ω—Ç–µ—Ä–µ—Å" },
      { id: "trust", text: "ü§ó –î–æ–≤–µ—Ä–∏–µ / –ø—Ä–∏–Ω—è—Ç–∏–µ" }
    ];

    const emotionMap = {
      "üò¢ –ì—Ä—É—Å—Ç—å / –ø–µ—á–∞–ª—å": "sadness",
      "üò† –ó–ª–æ—Å—Ç—å / —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ": "anger",
      "üòÆ –£–¥–∏–≤–ª–µ–Ω–∏–µ / –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–µ": "surprise",
      "ü§ó –î–æ–≤–µ—Ä–∏–µ / –ø—Ä–∏–Ω—è—Ç–∏–µ": "trust",
      "üòä –†–∞–¥–æ—Å—Ç—å / —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ": "joy",
      "üò® –°—Ç—Ä–∞—Ö / —Ç—Ä–µ–≤–æ–≥–∞": "fear",
      "ü§¢ –û—Ç–≤—Ä–∞—â–µ–Ω–∏–µ / –Ω–µ–ø—Ä–∏—è–∑–Ω—å": "disgust",
      "üßê –û–∂–∏–¥–∞–Ω–∏–µ / –∏–Ω—Ç–µ—Ä–µ—Å": "interest",
      "üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ": "neutral"
    };

    function normalizeEmotionId(emotion_type, emotion_id) {
      const validIds = EMOTIONS.map(e => e.id);
      const cleanedId = emotion_id?.trim()?.toLowerCase();
      if (validIds.includes(cleanedId)) return cleanedId;
      return emotionMap[emotion_type] || "unknown";
    }

    let allEntries = [];

    async function fetchEmotions() {
      try {
        const response = await fetch(`${API_URL}?client_id=${encodeURIComponent(clientId)}`);
        const data = await response.json();
        console.log("üì¶ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", data);

        if (!Array.isArray(data) || data.length === 0) {
          document.getElementById('emotion-list').innerHTML = "<p style='text-align:center;'>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</p>";
        } else {
          allEntries = data;
          renderFilters();
          renderEmotions(allEntries);
        }

        document.getElementById('loader').style.display = 'none';
        document.querySelector('main').style.display = 'block';
      } catch (err) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:", err);
        document.getElementById('emotion-list').innerHTML = "<p style='text-align:center;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</p>";
        document.getElementById('loader').style.display = 'none';
        document.querySelector('main').style.display = 'block';
      }
    }

    function renderFilters() {
      const container = document.getElementById('emotion-filters');
      container.innerHTML = "";

      const counts = {};
      EMOTIONS.forEach(em => {
        counts[em.id] = allEntries.filter(e =>
          normalizeEmotionId(e.emotion_type, e.emotion_id) === em.id
        ).length;
      });

      const allActive = allEntries.length > 0;
      const btnAll = document.createElement('button');
      btnAll.textContent = "–í—Å–µ —ç–º–æ—Ü–∏–∏";
      btnAll.className = allActive ? "active all-emotions" : "inactive all-emotions";
      if (allActive) btnAll.onclick = () => renderEmotions(allEntries);
      container.appendChild(btnAll);

      EMOTIONS.forEach(em => {
        const btn = document.createElement('button');
        btn.textContent = em.text;

        if (counts[em.id] > 0) {
          btn.className = "active";
          btn.onclick = () => {
            const filtered = allEntries.filter(e =>
              normalizeEmotionId(e.emotion_type, e.emotion_id) === em.id
            );
            renderEmotions(filtered);
          };
        } else {
          btn.className = "inactive";
        }

        container.appendChild(btn);
      });
    }

    function renderEmotions(entries) {
      const container = document.getElementById('emotion-list');
      container.innerHTML = "";
      if (entries.length === 0) {
        container.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —ç–º–æ—Ü–∏–∏.</p>";
        return;
      }

      entries.forEach(e => {
        const div = document.createElement('div');
        div.className = "entry";
        div.innerHTML = `
          <h4>${e.emotion_type}</h4>
          <p><b>–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å:</b> ${e.emotion_intens}/10</p>
          <p><b>–°–∏—Ç—É–∞—Ü–∏—è:</b> ${e.emotion_context}</p>
          <p><b>–†–µ–∞–∫—Ü–∏—è:</b> ${e.emotion_reflex}</p>
          <p><b>–ú—ã—Å–ª–∏:</b> ${e.emotion_think}</p>
          <p style="font-size:12px; color:#999;">${new Date(e.date).toLocaleString()}</p>
        `;
        container.appendChild(div);
      });
    }

    function applyTheme(theme) {
      document.body.classList.toggle('dark', theme === 'dark');
      localStorage.setItem('theme', theme);
      const toggleBtn = document.getElementById('theme-toggle');
      toggleBtn.textContent = theme === 'dark' ? 'üåû' : 'üåô';
    }

    function toggleTheme() {
      const current = document.body.classList.contains('dark') ? 'dark' : 'light';
      const next = current === 'dark' ? 'light' : 'dark';
      applyTheme(next);

      const btn = document.getElementById('theme-toggle');
      btn.classList.add('clicked');
      setTimeout(() => btn.classList.remove('clicked'), 400);
    }

    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
      fetchEmotions();
    });
  </script>
</body>
</html>
